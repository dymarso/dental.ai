# 1: docker compose -f development.yml --profile init run --rm frontend-init ; docker compose -f development.yml --profile init run --rm backend-init
# 2: DOCKER_BUILDKIT=1 docker compose -f development.yml build --parallel && docker compose -f development.yml up -d --remove-orphans
# To create a backend feature's app: APP_NAME=changename docker compose --profile init -f development.yml run --rm app-init
# Include/Remove add-on on package.json: docker compose -f development.yml --profile init run --rm npm-init
# DB Backup: docker compose -f development.yml exec backend /backend/_config/backup/backup.sh backup-db
# Snapshot Backup: FULL_BACKUP=true docker compose -f development.yml --profile backup run --rm backup-snapshot
# List backups: docker compose -f development.yml --profile backup run --rm backup-list
# Manual restore: docker compose -f development.yml exec backend /backend/_config/backup/backup.sh restore

# ML Service Architecture:
#   Development (Local): ML built into Django backend at /ml_service/ endpoints
#     - Uses development.txt requirements - No separate service needed - ML_SERVICE_URL environment variable should be empty/unset
#   Production (Cloud): Lightweight backend + External ML service (REQUIRED)
#     - Backend uses deployment.txt - Deploy external ML service separately (serverless, auto-scaling) - MUST set ML_SERVICE_URL environment variable to external ML service

volumes:
  db_data:

services:
  traefik:
    image: traefik:v3.6.5
    ports:
      - "80:80"
      - "8080:8080"   # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    command:
      # Logging
      - "--log.level=INFO"
      - "--log.format=json"
      - "--accesslog=true"
      - "--accesslog.format=json"
      - "--accesslog.bufferingsize=100"

      # API & Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=true"

      # Health check
      - "--ping=true"
      - "--ping.entrypoint=web"

      # Metrics (Prometheus)
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.addEntryPointsLabels=true"
      - "--metrics.prometheus.addRoutersLabels=true"
      - "--metrics.prometheus.addServicesLabels=true"

      # Entrypoints
      - "--entrypoints.web.address=:80"

      # Connection settings
      - "--entrypoints.web.transport.respondingTimeouts.readTimeout=60s"
      - "--entrypoints.web.transport.respondingTimeouts.writeTimeout=60s"
      - "--entrypoints.web.transport.respondingTimeouts.idleTimeout=180s"

      # Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.endpoint=unix:///var/run/docker.sock"
      - "--providers.docker.watch=true"

      # Global middlewares
      - "--global.checknewversion=true"
      - "--global.sendanonymoususage=false"

  backend:
    build:
      context: .
      dockerfile: backend/_config/Dockerfile.development
    environment:
      DJANGO_DEBUG: "true"
      DJANGO_SECRET_KEY: "INSECURE-DEV-KEY-CHANGE-IN-PRODUCTION"
      DOMAIN: "localhost"
      DB_HOST: "db"
      DB_PORT: "5432"
      DB_NAME: "postgres"
      DB_USER: "postgres"
      DB_PASSWORD: "postgres"
      DJANGO_SUPERUSER_USERNAME: "admin"
      DJANGO_SUPERUSER_PASSWORD: "admin"
      DJANGO_SUPERUSER_EMAIL: "3@edy.chat"
      # ML Service configuration
      # Development: Leave empty (uses built-in /ml_service/ endpoints with development.txt ML deps)
      # Production: MUST set to external ML service URL (backend uses deployment.txt without ML)
      ML_SERVICE_URL: "${ML_SERVICE_URL:-}"
    volumes:
      - ./backend:/backend:delegated
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 1m
      timeout: 3s
      retries: 10
      start_period: 10s
    labels:
      - "traefik.enable=true"

      # Backend routes handled by Traefik
      - "traefik.http.routers.backend.rule=Host(`localhost`) && (PathPrefix(`/api`) || PathPrefix(`/admin`) || PathPrefix(`/static`) || PathPrefix(`/media`))"
      - "traefik.http.routers.backend.entrypoints=web"
      - "traefik.http.routers.backend.priority=100"

      # Middlewares
      # Remove /api prefix ONLY for local backend
      - "traefik.http.middlewares.strip-api-prefix.stripprefix.prefixes=/api"

      # Security headers
      - "traefik.http.middlewares.backend-security-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.backend-security-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.backend-security-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.backend-security-headers.headers.sslRedirect=false"

      # Compression
      - "traefik.http.middlewares.backend-compress.compress=true"

      # Rate limiting (100 requests per second average, burst of 200)
      - "traefik.http.middlewares.backend-ratelimit.ratelimit.average=100"
      - "traefik.http.middlewares.backend-ratelimit.ratelimit.burst=200"
      - "traefik.http.middlewares.backend-ratelimit.ratelimit.period=1s"

      # Retry
      - "traefik.http.middlewares.backend-retry.retry.attempts=3"
      - "traefik.http.middlewares.backend-retry.retry.initialinterval=100ms"

      # Apply middleware chain
      - "traefik.http.routers.backend.middlewares=strip-api-prefix,backend-compress,backend-security-headers,backend-retry,backend-ratelimit"

      # Backend port
      - "traefik.http.services.backend.loadbalancer.server.port=8000"

    restart: unless-stopped

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    volumes:
      - ./frontend:/app:delegated
      - /app/node_modules
    depends_on:
      backend:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`localhost`)"
      - "traefik.http.routers.frontend.entrypoints=web"

      # Frontend middlewares
      # Security headers for frontend
      - "traefik.http.middlewares.frontend-security-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.frontend-security-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.frontend-security-headers.headers.sslRedirect=false"
      - "traefik.http.middlewares.frontend-security-headers.headers.customFrameOptionsValue=SAMEORIGIN"

      # Compression for frontend
      - "traefik.http.middlewares.frontend-compress.compress=true"

      # Rate limiting for frontend (more lenient than backend)
      - "traefik.http.middlewares.frontend-ratelimit.ratelimit.average=200"
      - "traefik.http.middlewares.frontend-ratelimit.ratelimit.burst=300"
      - "traefik.http.middlewares.frontend-ratelimit.ratelimit.period=1s"

      # Apply middleware chain
      - "traefik.http.routers.frontend.middlewares=frontend-compress,frontend-security-headers,frontend-ratelimit"

      # Service configuration with health check
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"
      - "traefik.http.services.frontend.loadbalancer.healthcheck.path=/"
      - "traefik.http.services.frontend.loadbalancer.healthcheck.interval=30s"
      - "traefik.http.services.frontend.loadbalancer.healthcheck.timeout=5s"
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: "512M"
        reservations:
          memory: "256M"
    restart: on-failure

  db:
    image: postgres:17
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${DB_USER:-postgres}"]
      interval: 5s
      timeout: 3s
      retries: 10
    restart: always


# Initialization Section ------------------
  frontend-init:
    profiles: ["init"]
    image: node:20
    volumes:
      - ./frontend:/app
    working_dir: /app
    command: >
      sh -c "
        echo 'üì¶ Starting frontend initialization...' &&
        npm install -g npm@latest &&

        echo 'üîÑ Backing up custom files...' &&
        mkdir -p /tmp/backup &&
        if [ -f Dockerfile ]; then cp Dockerfile /tmp/backup/; fi &&
        if [ -f next.config.ts ]; then cp next.config.ts /tmp/backup/; fi &&
        if [ -f app/components/api.ts ]; then mkdir -p /tmp/backup/app/components && cp app/components/api.ts /tmp/backup/app/components/; fi &&

        echo 'üßπ Cleaning frontend directory completely...' &&
        rm -rf /app/* /app/.* 2>/dev/null || true &&

        echo 'ÔøΩ  Running create-next-app...' &&
        npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir=false --import-alias='@/*' --turbopack --no-git &&

        echo 'ÔøΩ  Installing dependencies...' &&
        npm install &&

        echo 'üîô Restoring custom files...' &&
        if [ -f /tmp/backup/Dockerfile ]; then mv /tmp/backup/Dockerfile ./; fi &&
        if [ -f /tmp/backup/next.config.ts ]; then mv /tmp/backup/next.config.ts ./; fi &&
        if [ -f /tmp/backup/app/components/api.ts ]; then mkdir -p app/components && mv /tmp/backup/app/components/api.ts app/components/; fi &&

        echo '‚úÖ Frontend initialization complete!'
      "

  npm-init:
    profiles: ["init"]
    image: node:18-slim
    working_dir: /app
    volumes:
      - ./frontend:/app
      - ./backend/_config/requirements/npm.txt:/deps/npm.txt:ro
    command: >
      sh -c '
        apt-get update && apt-get install -y jq && rm -rf /var/lib/apt/lists/* &&
        echo "üì¶ Syncing npm dependencies with /deps/npm.txt..." &&

        wanted_deps=$$(grep -v "^\s*#" /deps/npm.txt | sed "/^\s*$$/d")

        for dep in $$wanted_deps; do
          if ! grep -q "\"$$dep\"" package.json; then
            echo "Installing $$dep..."
            npm install "$$dep" --save --legacy-peer-deps
          else
            echo "$$dep already present, skipping."
          fi
        done

        current_deps=$$(jq -r ".dependencies | keys[]" package.json)
        for dep in $$current_deps; do
          if ! echo "$$wanted_deps" | grep -qx "$$dep"; then
            echo "Removing extra dependency $$dep..."
            npm uninstall "$$dep" --save
          fi
        done

        echo "‚úÖ package.json now strictly matches /deps/npm.txt"
      '

  backend-init:
    profiles: ["init"]
    image: python:3.11-slim
    volumes:
      - ./backend:/app
    working_dir: /app
    command: >
      sh -c '
        echo "üêç Starting backend initialization..." &&
        pip install --upgrade pip --root-user-action=ignore &&
        pip install --upgrade django --root-user-action=ignore &&

        echo "üì¶ Creating Django project..." &&
        django-admin startproject _config . &&

        echo "üìù Modifying settings.py..." &&

        sed -i "s/from pathlib import Path/import os\\nfrom pathlib import Path\\nimport dj_database_url/" _config/settings.py &&

        sed -i "s/^SECRET_KEY = .*/SECRET_KEY = os.getenv('\''DJANGO_SECRET_KEY'\'')/" _config/settings.py &&

        sed -i "s/^DEBUG = .*/DEBUG = os.getenv('\''DJANGO_DEBUG'\'', '\''False'\'').lower() == '\''true'\''/" _config/settings.py &&

        sed -i "/^DEBUG = /a\\\\nDOMAIN = os.getenv('\''DOMAIN'\'')\\nif not DOMAIN and not DEBUG:\\n    raise Exception('\''DOMAIN environment variable is required in production'\'')" _config/settings.py &&

        sed -i "s/^ALLOWED_HOSTS = \[\]/ALLOWED_HOSTS = []\\nif DEBUG:\\n    ALLOWED_HOSTS.extend(['\''localhost'\'', '\''127.0.0.1'\'', '\''0.0.0.0'\''])\\nelse:\\n    if DOMAIN:\\n        ALLOWED_HOSTS.extend([\\n            DOMAIN,\\n            f'\''api.{DOMAIN}'\'',\\n            f'\''www.{DOMAIN}'\'',\\n        ])/" _config/settings.py &&

        sed -i "/^# Application definition/a\\\\n# Dynamically find all apps in the backend folder\\ndef find_apps(base_dir, exclude_dirs=None):\\n    exclude_dirs = exclude_dirs or []\\n    exclude_dirs = list(exclude_dirs) + ['\''_config'\'']\\n    apps = []\\n    for item in os.listdir(base_dir):\\n        item_path = os.path.join(base_dir, item)\\n        if (\\n            os.path.isdir(item_path) and\\n            item not in exclude_dirs and\\n            os.path.isfile(os.path.join(item_path, '\''__init__.py'\''))\\n        ):\\n            apps.append(item)\\n    return apps" _config/settings.py &&

        sed -i "s/^INSTALLED_APPS = \[/INSTALLED_APPS = [\\n    '\''corsheaders'\'',\\n    '\''rest_framework'\'',\\n    '\''rest_framework.authtoken'\'',\\n    '\''import_export'\'',/" _config/settings.py &&

        sed -i "/^INSTALLED_APPS = /,/^\]/s/\]/] + find_apps(BASE_DIR)\\nif DEBUG:\\n    INSTALLED_APPS += ['\''django_extensions'\'']/" _config/settings.py &&

        sed -i "s/^MIDDLEWARE = \[/MIDDLEWARE = [\\n    '\''corsheaders.middleware.CorsMiddleware'\'',\\n    '\''whitenoise.middleware.WhiteNoiseMiddleware'\'',\\n    '\''django.middleware.locale.LocaleMiddleware'\'',/" _config/settings.py &&

        sed -i "/^# Database/,/^}/c\\# Database\\n# https://docs.djangoproject.com/en/5.2/ref/settings/#databases\\n\\n\\nif DEBUG:\\n    # Development: use PostgreSQL !\\n    DATABASES = {\\n        '\''default'\'': {\\n            '\''ENGINE'\'': '\''django.db.backends.postgresql'\'',\\n            '\''NAME'\'': os.getenv('\''DB_NAME'\''),\\n            '\''USER'\'': os.getenv('\''DB_USER'\''),\\n            '\''PASSWORD'\'': os.getenv('\''DB_PASSWORD'\''),\\n            '\''HOST'\'': os.getenv('\''DB_HOST'\''),\\n            '\''PORT'\'': os.getenv('\''DB_PORT'\''),\\n        }\\n    }\\nelse:\\n    # Production: Railway DATABASE_URL\\n    DATABASES = {\\n        '\''default'\'': dj_database_url.config(\\n            default='\''postgres://user:password@host:5432/dbname'\'',\\n            conn_max_age=600,\\n            ssl_require=True,\\n        )\\n    }" _config/settings.py &&

        sed -i "s/^LANGUAGE_CODE = .*/LANGUAGE_CODE = '\''es-mx'\''/" _config/settings.py &&
        sed -i "/^LANGUAGE_CODE = /a\\LANGUAGES = [\\n    ('\''en'\'', '\''English'\''),\\n    ('\''es'\'', '\''Spanish'\''),\\n]" _config/settings.py &&

        sed -i "s|^STATIC_URL = .*|STATIC_URL = '\''/static/'\''|" _config/settings.py &&

        sed -i "/^STATIC_URL = /a\\STATIC_ROOT = os.path.join(BASE_DIR, '\''_config/staticfiles'\'')\\n\\n# Media files\\nMEDIA_URL = '\''/media/'\''\\nMEDIA_ROOT = os.path.join(BASE_DIR, '\''media'\'')" _config/settings.py &&

        sed -i "/^DEFAULT_AUTO_FIELD = /a\\\\n# REST Framework\\nREST_FRAMEWORK = {\\n    '\''DEFAULT_PERMISSION_CLASSES'\'': ['\''rest_framework.permissions.AllowAny'\''],\\n    '\''DEFAULT_RENDERER_CLASSES'\'': ['\''rest_framework.renderers.JSONRenderer'\''],\\n    '\''DEFAULT_PARSER_CLASSES'\'': [\\n        '\''rest_framework.parsers.JSONParser'\'',\\n        '\''rest_framework.parsers.MultiPartParser'\'',\\n        '\''rest_framework.parsers.FormParser'\'',\\n    ],\\n}\\n\\n# CORS settings\\nCORS_ALLOW_CREDENTIALS = True\\n\\n# Base CORS allowed origins\\nCORS_ALLOWED_ORIGINS = []\\nCSRF_TRUSTED_ORIGINS = []\\nif DEBUG:\\n    CORS_ALLOW_ALL_ORIGINS = True\\n    CORS_ALLOWED_ORIGIN_REGEXES = [\\n        r'\''^http://localhost:\\\\d+$$'\'',\\n        r'\''^http://127.0.0.1:\\\\d+$$'\'',\\n    ]\\n    CSRF_TRUSTED_ORIGINS.extend([\\n        '\''http://localhost:3000'\'',\\n        '\''http://127.0.0.1:3000'\'',\\n        '\''http://localhost:8000'\'',\\n        '\''http://127.0.0.1:8000'\'',\\n    ])\\nelse:\\n    CORS_ALLOW_ALL_ORIGINS = False\\n    if DOMAIN:\\n        CORS_ALLOWED_ORIGINS.extend([\\n            f'\''https://{DOMAIN}'\'',\\n            f'\''https://www.{DOMAIN}'\'',\\n        ])\\n        CSRF_TRUSTED_ORIGINS.extend([\\n            f'\''https://{DOMAIN}'\'',\\n            f'\''https://www.{DOMAIN}'\'',\\n            f'\''https://api.{DOMAIN}'\'',\\n        ])\\n\\nCORS_EXPOSE_HEADERS = ['\''Content-Type'\'', '\''X-CSRFToken'\'']\\nCORS_ALLOW_HEADERS = [\\n    '\''accept'\'',\\n    '\''accept-encoding'\'',\\n    '\''authorization'\'',\\n    '\''content-type'\'',\\n    '\''dnt'\'',\\n    '\''origin'\'',\\n    '\''user-agent'\'',\\n    '\''x-csrftoken'\'',\\n    '\''x-requested-with'\'',\\n]\\n\\n# Cookie settings\\nif DEBUG:\\n    SESSION_COOKIE_SECURE = False\\n    CSRF_COOKIE_SECURE = False\\n    SESSION_COOKIE_SAMESITE = '\''Lax'\''\\n    CSRF_COOKIE_SAMESITE = '\''Lax'\''\\n    SESSION_COOKIE_DOMAIN = None\\n    CSRF_COOKIE_DOMAIN = None\\nelse:\\n    SESSION_COOKIE_SECURE = True\\n    CSRF_COOKIE_SECURE = True\\n    SESSION_COOKIE_SAMESITE = '\''None'\''\\n    CSRF_COOKIE_SAMESITE = '\''None'\''\\n    if DOMAIN:\\n        SESSION_COOKIE_DOMAIN = f'\''.{DOMAIN}'\''\\n        CSRF_COOKIE_DOMAIN = f'\''.{DOMAIN}'\''\\n\\n# Import/Export Configuration\\n# Optimize for large dataset imports (30k+ records)\\nIMPORT_EXPORT_USE_TRANSACTIONS = True  # Use transactions for data integrity\\nIMPORT_EXPORT_CHUNK_SIZE = 1000  # Process 1000 records per transaction\\nIMPORT_EXPORT_SKIP_ADMIN_LOG = True  # Skip admin log entries to save memory\\nIMPORT_EXPORT_TMP_STORAGE_CLASS = '\''import_export.tmp_storages.TempFolderStorage'\''  # Use temp files instead of memory\\n# File Upload Settings - Allow larger files for CSV imports\\nDATA_UPLOAD_MAX_MEMORY_SIZE = 52428800  # 50 MB (increased from default 2.5 MB)\\nFILE_UPLOAD_MAX_MEMORY_SIZE = 52428800  # 50 MB\\n\\n# Debug prints\\nif DEBUG:\\n    print(f\\\"‚äß {DATABASES['\''default'\'']['\''ENGINE'\'']}\\\"\\n    print(f\\\"‚äß DEBUG: {DEBUG} {ALLOWED_HOSTS}\\\")" _config/settings.py &&

        echo "üìù Modifying urls.py..." &&

        sed -i "1i\\# backend/urls.py" _config/urls.py &&
        sed -i "s/from django.contrib import admin/import os\\nimport importlib\\nfrom django.contrib import admin/" _config/urls.py &&
        sed -i "s/from django.urls import path/from django.urls import path, include\\nfrom django.http import JsonResponse\\nfrom django.middleware.csrf import get_token/" _config/urls.py &&

        sed -i "/^from django.middleware.csrf import get_token/a\\\\n\\n# --- Dynamic app discovery ---\\ndef find_apps(base_dir, exclude_dirs=None):\\n    exclude_dirs = exclude_dirs or []\\n    exclude_dirs = list(exclude_dirs) + ['\''_config'\'', '\''__pycache'\'']\\n    apps = []\\n    for item in os.listdir(base_dir):\\n        item_path = os.path.join(base_dir, item)\\n        if (\\n            os.path.isdir(item_path)\\n            and item not in exclude_dirs\\n            and os.path.isfile(os.path.join(item_path, '\''__init__.py'\''))\\n        ):\\n            apps.append(item)\\n    return apps\\n\\n\\n# --- Health and CSRF endpoints ---\\ndef health_check(request):\\n    return JsonResponse({'\''status'\'': '\''healthy'\'', '\''service'\'': '\''backend'\''})\\n\\n\\ndef csrf_token(request):\\n    \\\"\\\"\\\"CSRF token endpoint for frontend API calls\\\"\\\"\\\"\\n    return JsonResponse({'\''csrfToken'\'': get_token(request)})\\n" _config/urls.py &&

        sed -i "s/^urlpatterns = \[/# --- Build urlpatterns dynamically ---\\nurlpatterns = [\\n    path('\''health\\/'\'', health_check, name='\''health-check'\''),\\n    path('\''csrf\\/'\'', csrf_token, name='\''csrf-token'\''),/" _config/urls.py &&

        sed -i "/^\]/a\\\\n\\nBASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))\\napps = find_apps(BASE_DIR, exclude_dirs=['\''backend'\'', '\''migrations'\''])\\n\\nfor app in apps:\\n    try:\\n        importlib.import_module(f'\''{app}.urls'\'')  # check if app has urls\\n        urlpatterns.append(path(f'\''{app}\\/'\'', include(f'\''{app}.urls'\'')))\\n    except ModuleNotFoundError:\\n        # silently skip apps without urls.py\\n        pass" _config/urls.py &&

        echo "‚úÖ Backend initialization complete!"
      '

  app-init:
    profiles: ["init"]
    image: python:3.11-slim
    volumes:
      - ./backend:/app
    working_dir: /app
    command: >
      sh -c "
      apt-get update &&
      apt-get install -y sed &&
      pip install --upgrade pip --root-user-action=ignore &&
      pip install django python-decouple djangorestframework django-cors-headers --root-user-action=ignore &&
      django-admin startapp ${APP_NAME:-app}
      "
    environment:
      - APP_NAME=${APP_NAME:-app}

# Backup Section ------------------
# Note: Daily DB backups are AUTOMATIC ONLY (via cron at 2:00 AM)
# Manual operations available: Full snapshot, Restore, List

# Full snapshot (requires FULL_BACKUP=true)
  backup-snapshot:
    profiles: ["backup"]
    image: postgres:17
    environment:
      DB_HOST: "${DB_HOST:-db}"
      DB_PORT: "${DB_PORT:-5432}"
      DB_NAME: "${DB_NAME:-postgres}"
      DB_USER: "${DB_USER:-postgres}"
      DB_PASSWORD: "${DB_PASSWORD:-postgres}"
      DJANGO_DEBUG: "true"
      FULL_BACKUP: "${FULL_BACKUP:-false}"
    volumes:
      - ./backend:/backend
    working_dir: /backend/_config/backup
    depends_on:
      db:
        condition: service_healthy
    command: >
      sh -c "
        echo 'üì¶ Installing required packages...' &&
        apt-get update -qq &&
        apt-get install -y -qq postgresql-client gzip tar cpio > /dev/null 2>&1 &&
        echo '‚úÖ Packages installed' &&
        echo '' &&
        FULL_BACKUP=true /backend/_config/backup/backup.sh snapshot
      "

  backup-restore:
    profiles: ["backup"]
    image: postgres:17
    environment:
      DB_HOST: "${DB_HOST:-db}"
      DB_PORT: "${DB_PORT:-5432}"
      DB_NAME: "${DB_NAME:-postgres}"
      DB_USER: "${DB_USER:-postgres}"
      DB_PASSWORD: "${DB_PASSWORD:-postgres}"
      RESTORE_ARCHIVE: "${RESTORE_ARCHIVE:-}"
      DJANGO_DEBUG: "true"
    volumes:
      - ./backend:/backend
    working_dir: /backend/_config/backup
    depends_on:
      db:
        condition: service_healthy
    entrypoint: >
      sh -c '
        if [ -z "$${RESTORE_ARCHIVE}" ]; then
          echo "‚ùå Error: Backup archive path required";
          echo "Usage: RESTORE_ARCHIVE=/backend/_config/backup/snapshots/<file.tar.gz> docker compose -f development.yml --profile backup run --rm backup-restore";
          echo "";
          echo "Available backups:";
          /backend/_config/backup/backup.sh list;
          exit 1;
        fi &&
        echo "üì¶ Installing required packages..." &&
        apt-get update -qq &&
        apt-get install -y -qq postgresql-client gzip tar cpio > /dev/null 2>&1 &&
        echo "‚úÖ Packages installed" &&
        echo "" &&
        /backend/_config/backup/backup.sh restore
      '

  backup-list:
    profiles: ["backup"]
    image: postgres:17
    volumes:
      - ./backend:/backend
    working_dir: /backend/_config/backup
    environment:
      DJANGO_DEBUG: "true"
    command: /backend/_config/backup/backup.sh list
